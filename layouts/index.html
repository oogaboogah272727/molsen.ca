{{ define "main" }}
<p class="intro">{{ .Site.Params.description }}</p>

<div class="essay-browser">
  <div class="browser-controls">
    <a href="https://chatgpt.com/g/g-6955c39bc1ac81919d433f0b950561b6-explore-mike-olsen-s-writing-on-molsen-ca" class="chat-link" target="_blank" rel="noopener">Chat with site contents on ChatGPT</a>
    <div class="tag-filters" id="tag-filters"></div>
  </div>

  <div class="category-sections" id="category-sections">
    <p class="loading">Loading essays...</p>
  </div>
</div>

<script>
const TYPE_LABELS = {
  'hub': 'Start Here',
  'foundational': 'Foundations',
  'core': 'Core Framework',
  'theoretical': 'Theory',
  'applied': 'Applied',
  'practice': 'Practice',
  'empirical': 'Empirical'
};

const TYPE_ORDER = ['hub', 'foundational', 'core', 'theoretical', 'applied', 'practice', 'empirical'];

let essays = [];
let activeTags = new Set();

async function init() {
  const response = await fetch('/index.json');
  essays = await response.json();

  // Filter out _index pages
  essays = essays.filter(e => e.title && !e.url.endsWith('/writing/'));

  renderTagFilters();
  renderEssays();
}

function renderTagFilters() {
  const allTags = new Set();
  essays.forEach(e => (e.tags || []).forEach(t => allTags.add(t)));

  const container = document.getElementById('tag-filters');
  container.innerHTML = Array.from(allTags).sort().map(tag =>
    `<button class="tag-btn" data-tag="${tag}">${tag}</button>`
  ).join('');

  container.querySelectorAll('.tag-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tag = btn.dataset.tag;
      if (activeTags.has(tag)) {
        activeTags.delete(tag);
        btn.classList.remove('active');
      } else {
        activeTags.add(tag);
        btn.classList.add('active');
      }
      renderEssays();
    });
  });
}

function renderEssays() {
  const filtered = essays.filter(e => {
    // Tag filter
    if (activeTags.size > 0) {
      const hasTag = (e.tags || []).some(t => activeTags.has(t));
      if (!hasTag) return false;
    }
    return true;
  });

  // Group by type
  const grouped = {};
  filtered.forEach(e => {
    const type = e.type || 'essay';
    if (!grouped[type]) grouped[type] = [];
    grouped[type].push(e);
  });

  // Render
  const container = document.getElementById('category-sections');

  if (filtered.length === 0) {
    container.innerHTML = '<p class="no-results">No essays match your filters.</p>';
    return;
  }

  let html = '';
  TYPE_ORDER.forEach(type => {
    if (!grouped[type]) return;
    const label = TYPE_LABELS[type] || type;
    html += `<div class="category-section">
      <h2>${label}</h2>
      <div class="essay-grid">
        ${grouped[type].map(e => `
          <a href="${e.url}" class="essay-card">
            <h3>${e.title}</h3>
            <p>${e.description || ''}</p>
            <div class="essay-tags">${(e.tags || []).map(t => `<span class="tag">${t}</span>`).join('')}</div>
          </a>
        `).join('')}
      </div>
    </div>`;
  });

  container.innerHTML = html;
}

init();
</script>

<div class="llm-access">
  <h2>LLM Access</h2>
  <p>This site's content is available in LLM-friendly formats:</p>
  <div class="llm-links">
    <a href="/llms.txt" class="llm-link">
      <strong>llms.txt</strong>
      <span>Framework overview and essay summaries (~9 KB)</span>
    </a>
    <a href="/llms-full.txt" class="llm-link">
      <strong>llms-full.txt</strong>
      <span>Complete text of all essays (~210 KB)</span>
    </a>
    <a href="https://github.com/oogaboogah272727/molsen.ca-mcp" class="llm-link" target="_blank" rel="noopener">
      <strong>MCP Server</strong>
      <span>Connect Claude Desktop or Claude Code directly to these essays</span>
    </a>
  </div>
</div>
{{ end }}
